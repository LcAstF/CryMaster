<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CryMaster Payment QR Mini App</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://unpkg.com/react@17/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@17/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/babel-standalone@6/babel.min.js"></script>
    <script src="https://unpkg.com/qrcode.react@3.1.0/lib/qrcode.min.js"></script>
    <script src="https://unpkg.com/lucide-react@0.263.1/dist/umd/lucide-react.min.js"></script>
    <script src="https://unpkg.com/dompurify@2.3.3/dist/purify.min.js"></script>
    <script src="https://unpkg.com/lodash@4.17.21/lodash.min.js"></script>
    <script src="https://unpkg.com/react-qr-reader@3.0.0-beta-1/dist/index.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body>
    <div id="root"></div>
    <script type="text/babel">
        const { useState, useEffect, useCallback } = React;
        const { QRCodeSVG } = qrcode.react;
        const { Camera, AlertTriangle } = lucide;
        const { QrReader } = ReactQrReader;
        const { debounce } = _;

        // Simple Alert component implementation
        const Alert = ({ children, variant }) => (
            <div className={`p-4 mb-4 rounded ${variant === 'destructive' ? 'bg-red-100 text-red-700' : 'bg-blue-100 text-blue-700'}`}>
                {children}
            </div>
        );

        const AlertTitle = ({ children }) => <h3 className="font-bold">{children}</h3>;
        const AlertDescription = ({ children }) => <p>{children}</p>;

        // Simulated API function (replace with your actual API)
        const api = {
            processPayment: async (amount, address, currency = 'USD') => {
                await new Promise(resolve => setTimeout(resolve, 1000));
                if (Math.random() > 0.2) {
                    return { success: true, message: 'Payment processed successfully' };
                } else {
                    throw new Error('Payment failed. Please try again.');
                }
            },
        };

        // Rate limiting hook
        const useRateLimit = (limit, interval) => {
            const [count, setCount] = useState(0);

            useEffect(() => {
                const timer = setInterval(() => setCount(0), interval);
                return () => clearInterval(timer);
            }, [interval]);

            return useCallback(() => {
                if (count >= limit) {
                    throw new Error('Rate limit exceeded. Please try again later.');
                }
                setCount(prev => prev + 1);
            }, [count, limit]);
        };

        const PaymentQRMiniApp = () => {
            const [mode, setMode] = useState('generate');
            const [amount, setAmount] = useState('');
            const [walletAddress, setWalletAddress] = useState('');
            const [qrData, setQrData] = useState('');
            const [scanResult, setScanResult] = useState('');
            const [error, setError] = useState('');
            const [isProcessing, setIsProcessing] = useState(false);
            const [user, setUser] = useState(null);
            const [theme, setTheme] = useState(null);

            const checkRateLimit = useRateLimit(5, 60000); // 5 requests per minute

            useEffect(() => {
                // Initialize Telegram WebApp
                const webApp = window.Telegram.WebApp;
                webApp.ready();

                // Set up MainButton
                webApp.MainButton.setText('Generate QR').show();

                // Access user data
                const userData = webApp.initDataUnsafe.user;
                setUser(userData);

                // Access theme data
                setTheme({
                    colorScheme: webApp.colorScheme,
                    themeParams: webApp.themeParams
                });

                // Event listener for MainButton
                const handleMainButtonClick = () => {
                    if (mode === 'generate') {
                        generateQR();
                    }
                };

                webApp.MainButton.onClick(handleMainButtonClick);

                // Cleanup
                return () => {
                    webApp.MainButton.offClick(handleMainButtonClick);
                };
            }, [mode]);

            useEffect(() => {
                setError('');
            }, [amount, walletAddress]);

            const sanitizeInput = (input) => {
                return DOMPurify.sanitize(input);
            };

            const validateInputs = () => {
                const sanitizedAmount = sanitizeInput(amount);
                const sanitizedAddress = sanitizeInput(walletAddress);

                if (!sanitizedAmount || isNaN(sanitizedAmount) || parseFloat(sanitizedAmount) <= 0) {
                    setError('Please enter a valid amount');
                    return false;
                }
                if (!sanitizedAddress || sanitizedAddress.length < 26 || sanitizedAddress.length > 35) {
                    setError('Please enter a valid wallet address');
                    return false;
                }
                return true;
            };

            const generateQR = async () => {
                try {
                    checkRateLimit();
                } catch (err) {
                    setError(err.message);
                    return;
                }

                if (!validateInputs()) return;

                const webApp = window.Telegram.WebApp;
                webApp.showConfirm(`Are you sure you want to process a payment of ${amount} to ${walletAddress}?`, (confirmed) => {
                    if (confirmed) {
                        processPayment();
                    }
                });
            };

            const processPayment = async () => {
                setIsProcessing(true);
                try {
                    const result = await api.processPayment(sanitizeInput(amount), sanitizeInput(walletAddress));
                    const data = JSON.stringify({ amount: sanitizeInput(amount), walletAddress: sanitizeInput(walletAddress), txId: Date.now() });
                    setQrData(data);
                    setError('');
                    window.Telegram.WebApp.showAlert(result.message);
                } catch (err) {
                    setError(err.message);
                    window.Telegram.WebApp.showAlert(err.message);
                } finally {
                    setIsProcessing(false);
                }
            };

            const handleScan = debounce((result) => {
                if (result) {
                    try {
                        const scannedData = JSON.parse(sanitizeInput(result?.text));
                        setScanResult(`Amount: ${scannedData.amount}, Wallet: ${scannedData.walletAddress}`);
                        setError('');
                    } catch (error) {
                        setError('Invalid QR Code');
                    }
                }
            }, 300);

            // Update MainButton based on mode
            useEffect(() => {
                const webApp = window.Telegram.WebApp;
                if (mode === 'generate') {
                    webApp.MainButton.setText('Generate QR').show();
                } else {
                    webApp.MainButton.hide();
                }
            }, [mode]);

            return (
                <div className="p-4 max-w-md mx-auto" style={{ backgroundColor: theme?.themeParams.bg_color, color: theme?.themeParams.text_color }}>
                    <h1 className="text-2xl font-bold mb-4">Secure Payment QR Mini App</h1>
                    
                    {user && (
                        <Alert className="mb-4">
                            <AlertTitle>Welcome, {user.first_name}!</AlertTitle>
                            <AlertDescription>User ID: {user.id}</AlertDescription>
                        </Alert>
                    )}

                    <div className="mb-4">
                        <button
                            className={`mr-2 px-4 py-2 rounded ${mode === 'generate' ? 'bg-blue-500 text-white' : 'bg-gray-200'}`}
                            onClick={() => setMode('generate')}
                        >
                            Generate QR
                        </button>
                        <button
                            className={`px-4 py-2 rounded ${mode === 'scan' ? 'bg-blue-500 text-white' : 'bg-gray-200'}`}
                            onClick={() => setMode('scan')}
                        >
                            Scan QR
                        </button>
                    </div>

                    {error && (
                        <Alert variant="destructive" className="mb-4">
                            <AlertTriangle className="h-4 w-4" />
                            <AlertTitle>Error</AlertTitle>
                            <AlertDescription>{error}</AlertDescription>
                        </Alert>
                    )}

                    {mode === 'generate' && (
                        <div>
                            <input
                                type="text"
                                placeholder="Amount"
                                value={amount}
                                onChange={(e) => setAmount(e.target.value)}
                                className="w-full p-2 mb-2 border rounded"
                                style={{ backgroundColor: theme?.themeParams.secondary_bg_color }}
                            />
                            <input
                                type="text"
                                placeholder="Wallet Address"
                                value={walletAddress}
                                onChange={(e) => setWalletAddress(e.target.value)}
                                className="w-full p-2 mb-2 border rounded"
                                style={{ backgroundColor: theme?.themeParams.secondary_bg_color }}
                            />
                            {qrData && (
                                <div className="mt-4 flex justify-center">
                                    <QRCodeSVG value={qrData} size={200} />
                                </div>
                            )}
                        </div>
                    )}

                    {mode === 'scan' && (
                        <div>
                            <Alert>
                                <Camera className="h-4 w-4" />
                                <AlertTitle>Scan QR Code</AlertTitle>
                                <AlertDescription>
                                    Position the QR code within the camera frame to scan.
                                </AlertDescription>
                            </Alert>
                            <div className="mt-4">
                                <QrReader
                                    onResult={handleScan}
                                    style={{ width: '100%' }}
                                    constraints={{ facingMode: 'environment' }}
                                />
                            </div>
                            {scanResult && (
                                <Alert className="mt-4">
                                    <AlertTitle>Scan Result</AlertTitle>
                                    <AlertDescription>{scanResult}</AlertDescription>
                                </Alert>
                            )}
                        </div>
                    )}
                </div>
            );
        };

        ReactDOM.render(<PaymentQRMiniApp />, document.getElementById('root'));
    </script>
</body>
</html>


